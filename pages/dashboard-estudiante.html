<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estudiante - RFID Campus</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/biblioteca.css" />
    <style>
      :root {
        --primary: #1e88e5;
        --primary-light: #42a5f5;
        --primary-dark: #1565c0;
        --bg-dark: #0d47a1;
        --success: #43a047;
        --warning: #fb8c00;
        --danger: #e53935;
      }

      .sidebar {
        background: linear-gradient(
          180deg,
          var(--bg-dark) 0%,
          var(--primary-dark) 100%
        );
      }

      .menu-item.active {
        background: var(--primary);
        border-left: 4px solid var(--primary-light);
      }

      .menu-item:hover {
        background: rgba(30, 136, 229, 0.15);
        border-left: 4px solid var(--primary);
      }

      .stat-card .icon {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
      }

      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--bg-dark) 100%
        );
      }

      .header-dash h1 {
        color: var(--bg-dark);
      }

      .glass-table-container h3 {
        color: var(--bg-dark);
      }

      .badge.bg-primary {
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
      }

      .search-container {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .search-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
      }

      .btn-search {
        padding: 12px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-search:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .result-info {
        margin-top: 10px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
        font-size: 13px;
        color: #666;
        text-align: center;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .block-warning {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-left: 5px solid var(--warning);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .block-warning h4 {
        color: #e65100;
        margin-bottom: 10px;
      }

      .block-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border-left: 5px solid var(--danger);
        padding: 20px;
        border-radius: 12px;
      }

      /* ========== MODAL PERFIL ========== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-perfil {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header-perfil {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 20px 20px 0 0;
      }

      .modal-header-perfil h2 {
        margin: 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .btn-close-modal {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .btn-close-modal:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .modal-body-perfil {
        padding: 30px;
      }

      .perfil-avatar {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .avatar-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 60px;
        box-shadow: 0 10px 30px rgba(30, 136, 229, 0.3);
      }

      .perfil-avatar h3 {
        margin: 10px 0 5px;
        color: #333;
        font-size: 24px;
      }

      .perfil-avatar p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .perfil-section {
        margin-bottom: 25px;
      }

      .perfil-section h4 {
        color: var(--primary-dark);
        font-size: 18px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
      }

      .info-label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 600;
      }

      .info-value {
        display: block;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }

      .stats-perfil {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .stat-perfil {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 2px solid #dee2e6;
      }

      .stat-perfil i {
        font-size: 36px;
        color: var(--primary);
      }

      .stat-info {
        display: flex;
        flex-direction: column;
      }

      .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #333;
      }

      .stat-label {
        font-size: 13px;
        color: #666;
      }

      @media (max-width: 768px) {
        .info-grid {
          grid-template-columns: 1fr;
        }

        .stats-perfil {
          grid-template-columns: 1fr;
        }

        .modal-perfil {
          width: 95%;
          margin: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div class="sidebar">
        <h3><i class="fas fa-user-graduate"></i> ESTUDIANTE</h3>
        <div class="menu-item active" onclick="cambiarVista('dashboard', this)">
          <i class="fas fa-home"></i> Dashboard
        </div>
        <div
          class="menu-item"
          onclick="toggleSubmenu('transacciones-submenu', this)"
        >
          <i class="fas fa-wallet"></i> Transacciones<i
            class="fas fa-chevron-down"
            style="margin-left: auto; font-size: 12px"
          ></i>
        </div>
        <div id="transacciones-submenu" class="submenu">
          <div
            class="submenu-item"
            onclick="cambiarVista('mis-transacciones', this)"
          >
            <i class="fas fa-list"></i> Mis Transacciones
          </div>
          <div
            class="submenu-item"
            onclick="cambiarVista('buscar-lineal', this)"
          >
            <i class="fas fa-search"></i> Buscar Movimiento
          </div>
          <div
            class="submenu-item"
            onclick="cambiarVista('buscar-binaria', this)"
          >
            <i class="fas fa-bullseye"></i> Buscar por Monto
          </div>
        </div>
        <div class="menu-item" onclick="cambiarVista('prestamos', this)">
          <i class="fas fa-book-reader"></i> Mis Pr√©stamos
        </div>
        <div class="menu-item" onclick="cambiarVista('pila', this)">
          <i class="fas fa-layer-group"></i> Historial PILA
        </div>
        <div class="menu-item" onclick="abrirModalPerfil()">
          <i class="fas fa-user-circle"></i> Mi Perfil
        </div>
        <div
          class="menu-item"
          style="margin-top: auto; color: #ff6b6b"
          onclick="cambiarVista('bloqueo', this)"
        >
          <i class="fas fa-lock"></i> Bloquear Tarjeta
        </div>
        <div class="menu-item" style="color: #ff6b6b" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
        </div>
      </div>

      <div class="main-content">
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section active">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-home"></i> Dashboard Principal</h1>
              <p>Panel de control del estudiante</p>
            </div>
            <button class="btn-primary" onclick="cargarDashboard()">
              <i class="fas fa-sync-alt"></i> Refrescar
            </button>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="icon"><i class="fas fa-wallet"></i></div>
              <h4>Saldo Disponible</h4>
              <div class="number" id="stat-saldo">$0.00</div>
            </div>
            <div class="stat-card">
              <div class="icon"><i class="fas fa-shopping-cart"></i></div>
              <h4>Transacciones</h4>
              <div class="number" id="stat-transacciones">0</div>
            </div>
            <div class="stat-card">
              <div class="icon"><i class="fas fa-book"></i></div>
              <h4>Pr√©stamos Activos</h4>
              <div class="number" id="stat-prestamos">0</div>
            </div>
            <div class="stat-card">
              <div class="icon"><i class="fas fa-user"></i></div>
              <h4>Mi Perfil</h4>
              <div class="number" style="font-size: 16px" id="stat-nombre">
                Cargando...
              </div>
            </div>
          </div>
          <div class="glass-table-container">
            <h3><i class="fas fa-clock"></i> Actividad Reciente</h3>
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Monto</th>
                </tr>
              </thead>
              <tbody id="tabla-actividad">
                <tr>
                  <td colspan="4" style="text-align: center; padding: 20px">
                    Cargando...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- MIS TRANSACCIONES -->
        <div id="view-mis-transacciones" class="view-section">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-list"></i> Mis Transacciones</h1>
              <p>Historial completo de compras y recargas</p>
            </div>
          </div>
          <div class="glass-table-container">
            <h3>
              <i class="fas fa-receipt"></i> Todas las Transacciones (<span
                id="contador-trans"
                >0</span
              >)
            </h3>
            <table>
              <thead>
                <tr>
                  <th>#ID</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tabla-transacciones">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 20px">
                    Cargando...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- BUSCAR LINEAL -->
        <div id="view-buscar-lineal" class="view-section">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-search"></i> B√∫squeda LINEAL</h1>
              <p>Busca transacciones por palabra clave</p>
            </div>
          </div>
          <div class="search-container">
            <div class="search-row">
              <input
                type="text"
                id="input-lineal"
                class="search-input"
                placeholder='Buscar por palabra clave (ej: "Coca", "Recarga")'
              />
              <button class="btn-search" onclick="buscarLineal()">
                <i class="fas fa-search"></i> Buscar
              </button>
            </div>
            <div
              id="result-lineal"
              class="result-info"
              style="display: none"
            ></div>
          </div>
          <div class="glass-table-container">
            <h3><i class="fas fa-list-alt"></i> Resultados de B√∫squeda</h3>
            <table>
              <thead>
                <tr>
                  <th>#ID</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tabla-lineal">
                <tr>
                  <td
                    colspan="5"
                    style="text-align: center; padding: 20px; color: #999"
                  >
                    <i
                      class="fas fa-search"
                      style="
                        font-size: 48px;
                        opacity: 0.2;
                        display: block;
                        margin-bottom: 10px;
                      "
                    ></i>
                    Escribe una palabra clave y presiona Buscar
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- BUSCAR BINARIA -->
        <div id="view-buscar-binaria" class="view-section">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-bullseye"></i> B√∫squeda BINARIA</h1>
              <p>Busca transacciones por monto exacto</p>
            </div>
          </div>
          <div class="search-container">
            <div class="search-row">
              <input
                type="number"
                step="0.01"
                id="input-binaria"
                class="search-input"
                placeholder="Ingresa el monto exacto (ej: 5.50)"
              />
              <button class="btn-search" onclick="buscarBinaria()">
                <i class="fas fa-bullseye"></i> Buscar
              </button>
            </div>
            <div
              id="result-binaria"
              class="result-info"
              style="display: none"
            ></div>
          </div>
          <div class="glass-table-container">
            <h3><i class="fas fa-calculator"></i> Resultado de B√∫squeda</h3>
            <table>
              <thead>
                <tr>
                  <th>#ID</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tabla-binaria">
                <tr>
                  <td
                    colspan="5"
                    style="text-align: center; padding: 20px; color: #999"
                  >
                    <i
                      class="fas fa-dollar-sign"
                      style="
                        font-size: 48px;
                        opacity: 0.2;
                        display: block;
                        margin-bottom: 10px;
                      "
                    ></i>
                    Ingresa un monto exacto y presiona Buscar
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PRESTAMOS -->
        <div id="view-prestamos" class="view-section">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-book-reader"></i> Mis Pr√©stamos</h1>
              <p>Libros que tienes prestados actualmente</p>
            </div>
          </div>
          <div class="glass-table-container">
            <h3>
              <i class="fas fa-book-open"></i> Pr√©stamos Activos (<span
                id="contador-prestamos"
                >0</span
              >)
            </h3>
            <table>
              <thead>
                <tr>
                  <th>#ID</th>
                  <th>Libro</th>
                  <th>Autor</th>
                  <th>Fecha Pr√©stamo</th>
                  <th>Devoluci√≥n Estimada</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="tabla-prestamos">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px">
                    Cargando...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PILA -->
        <div id="view-pila" class="view-section">
          <div class="header-dash">
            <div>
              <h1>
                <i class="fas fa-layer-group"></i> Historial con PILA (LIFO)
              </h1>
              <p>Estructura de datos: Last In, First Out</p>
            </div>
          </div>
          <div
            style="
              background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
              border-left: 5px solid var(--primary);
              padding: 20px;
              border-radius: 12px;
              margin-bottom: 20px;
            "
          >
            <h4 style="color: var(--primary-dark); margin-bottom: 10px">
              <i class="fas fa-info-circle"></i> ¬øQu√© es una PILA?
            </h4>
            <p style="color: #333; line-height: 1.6">
              Una <strong>PILA (Stack)</strong> es una estructura de datos que
              sigue el principio <strong>LIFO (Last In, First Out)</strong>. El
              √∫ltimo elemento en entrar es el primero en salir, como una pila de
              platos.
            </p>
          </div>
          <div class="glass-table-container">
            <h3>
              <i class="fas fa-stack-overflow"></i> Transacciones en orden LIFO
            </h3>
            <table>
              <thead>
                <tr>
                  <th>Posici√≥n</th>
                  <th>#ID</th>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tabla-pila">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px">
                    Cargando estructura PILA...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- BLOQUEO -->
        <div id="view-bloqueo" class="view-section">
          <div class="header-dash">
            <div>
              <h1><i class="fas fa-lock"></i> Bloquear Mi Tarjeta</h1>
              <p>Bloquea tu tarjeta en caso de p√©rdida o robo</p>
            </div>
          </div>
          <div class="block-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> ADVERTENCIA</h4>
            <p>
              Al bloquear tu tarjeta,
              <strong>NO podr√°s usar ning√∫n servicio del campus</strong> hasta
              que solicites una nueva tarjeta f√≠sica.
            </p>
          </div>
          <div class="block-danger">
            <h4><i class="fas fa-ban"></i> ACCI√ìN IRREVERSIBLE</h4>
            <p style="margin-bottom: 20px">
              Esta acci√≥n <strong>NO se puede deshacer</strong>. Tu tarjeta
              quedar√° bloqueada permanentemente.
            </p>
            <button
              class="btn-danger"
              onclick="bloquearTarjeta()"
              style="width: 100%; padding: 16px; font-size: 16px"
            >
              <i class="fas fa-lock"></i> CONFIRMAR BLOQUEO DE TARJETA
            </button>
            <p
              id="bloqueo-msg"
              style="
                margin-top: 15px;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
                font-weight: 600;
                display: none;
              "
            ></p>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL PERFIL -->
    <div id="modal-perfil" class="modal-overlay" onclick="cerrarModalPerfil()">
      <div class="modal-perfil" onclick="event.stopPropagation()">
        <div class="modal-header-perfil">
          <h2><i class="fas fa-user-circle"></i> Mi Perfil</h2>
          <button class="btn-close-modal" onclick="cerrarModalPerfil()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body-perfil">
          <!-- Avatar -->
          <div class="perfil-avatar">
            <div class="avatar-circle">
              <i class="fas fa-user"></i>
            </div>
            <h3 id="perfil-nombre">Cargando...</h3>
            <p id="perfil-email">email@ucacue.edu.ec</p>
          </div>

          <!-- Informaci√≥n Personal -->
          <div class="perfil-section">
            <h4><i class="fas fa-id-card"></i> Informaci√≥n Personal</h4>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Nombre Completo</span>
                <span class="info-value" id="perfil-nombre-completo">‚Äî</span>
              </div>
              <div class="info-item">
                <span class="info-label">Correo Electr√≥nico</span>
                <span class="info-value" id="perfil-correo">‚Äî</span>
              </div>
              <div class="info-item">
                <span class="info-label">Carrera</span>
                <span class="info-value" id="perfil-carrera">‚Äî</span>
              </div>
              <div class="info-item">
                <span class="info-label">ID Usuario</span>
                <span class="info-value" id="perfil-id">‚Äî</span>
              </div>
            </div>
          </div>

          <!-- Tarjeta RFID -->
          <div class="perfil-section">
            <h4><i class="fas fa-credit-card"></i> Tarjeta RFID</h4>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">C√≥digo RFID</span>
                <span class="info-value" id="perfil-rfid">‚Äî</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado Tarjeta</span>
                <span class="info-value" id="perfil-estado">‚Äî</span>
              </div>
              <div class="info-item">
                <span class="info-label">Saldo Actual</span>
                <span
                  class="info-value"
                  id="perfil-saldo"
                  style="
                    color: var(--primary);
                    font-weight: 700;
                    font-size: 18px;
                  "
                  >$0.00</span
                >
              </div>
            </div>
          </div>

          <!-- Estad√≠sticas -->
          <div class="perfil-section">
            <h4><i class="fas fa-chart-line"></i> Estad√≠sticas</h4>
            <div class="stats-perfil">
              <div class="stat-perfil">
                <i class="fas fa-shopping-cart"></i>
                <div class="stat-info">
                  <span class="stat-number" id="perfil-total-transacciones"
                    >0</span
                  >
                  <span class="stat-label">Transacciones</span>
                </div>
              </div>
              <div class="stat-perfil">
                <i class="fas fa-book"></i>
                <div class="stat-info">
                  <span class="stat-number" id="perfil-total-prestamos">0</span>
                  <span class="stat-label">Pr√©stamos</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log(" Sistema RFID Campus - Estudiante");
      const API_URL = "http://localhost:8080/api";
      const token = localStorage.getItem("jwt_token");
      if (!token) {
        alert("‚ö†Ô∏è Sesi√≥n expirada");
        window.location.href = "../index.html";
      }
      function getHeaders() {
        return {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
      }

      let usuarioActual = null;
      let transaccionesCache = [];

      function toggleSubmenu(id, menuItem) {
        const submenu = document.getElementById(id);
        const isOpen = submenu.style.display === "block";
        document
          .querySelectorAll(".submenu")
          .forEach((s) => (s.style.display = "none"));
        submenu.style.display = isOpen ? "none" : "block";
      }

      function cambiarVista(vistaNombre, elementoMenu) {
        console.log(" Cambiando a vista:", vistaNombre);
        document.querySelectorAll(".view-section").forEach((el) => {
          el.classList.remove("active");
          el.style.display = "none";
        });
        const vista = document.getElementById("view-" + vistaNombre);
        if (vista) {
          vista.classList.add("active");
          vista.style.display = "block";
        }
        document
          .querySelectorAll(".menu-item, .submenu-item")
          .forEach((el) => el.classList.remove("active"));
        if (elementoMenu) elementoMenu.classList.add("active");

        if (vistaNombre === "dashboard") cargarDashboard();
        if (vistaNombre === "mis-transacciones") cargarTransacciones();
        if (vistaNombre === "prestamos") cargarPrestamos();
        if (vistaNombre === "pila") cargarPila();
      }

      function logout() {
        if (confirm("¬øCerrar sesi√≥n?")) {
          localStorage.removeItem("jwt_token");
          window.location.href = "../index.html";
        }
      }

      async function cargarUsuario() {
        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          const email = payload.sub;
          const res = await fetch(`${API_URL}/usuarios`, {
            headers: getHeaders(),
          });
          if (!res.ok) throw new Error("Error al cargar usuarios");
          const usuarios = await res.json();
          usuarioActual = usuarios.find((u) => u.email === email);
          if (usuarioActual) {
            const saldo = Number(usuarioActual.saldo || 0).toFixed(2);
            document.getElementById("stat-saldo").textContent = `$${saldo}`;
            document.getElementById("stat-nombre").textContent =
              usuarioActual.nombreCompleto || "Usuario";
          }
          console.log(" Usuario cargado:", usuarioActual);
        } catch (error) {
          console.error(" Error al cargar usuario:", error);
        }
      }

      async function cargarDashboard() {
        console.log(" Cargando dashboard...");
        await cargarUsuario();

        try {
          const res = await fetch(`${API_URL}/estudiante/mis-transacciones`, {
            headers: getHeaders(),
          });
          if (!res.ok) throw new Error("Error");
          const trans = await res.json();
          document.getElementById("stat-transacciones").textContent =
            trans.length;

          const tbody = document.getElementById("tabla-actividad");
          if (trans.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">No hay actividad reciente</td></tr>';
          } else {
            const ultimas = trans.slice(0, 5);
            tbody.innerHTML = ultimas
              .map(
                (t) => `
        <tr>
          <td>${new Date(t.fecha).toLocaleDateString("es-EC")}</td>
          <td><span class="badge bg-primary">${t.tipo}</span></td>
          <td>${t.detalle || "‚Äî"}</td>
          <td><strong>$${Number(t.monto).toFixed(2)}</strong></td>
        </tr>
      `,
              )
              .join("");
          }
        } catch (error) {
          console.error("‚ùå Error:", error);
        }

        try {
          const res = await fetch(
            `${API_URL}/estudiante/mis-prestamos-pendientes`,
            { headers: getHeaders() },
          );
          if (!res.ok) throw new Error("Error");
          const prestamos = await res.json();
          document.getElementById("stat-prestamos").textContent =
            prestamos.length;
        } catch (error) {
          console.error("‚ùå Error:", error);
        }

        console.log(" Dashboard cargado");
      }

      async function cargarTransacciones() {
        try {
          const res = await fetch(`${API_URL}/estudiante/mis-transacciones`, {
            headers: getHeaders(),
          });
          if (!res.ok) throw new Error("Error");
          transaccionesCache = await res.json();

          const tbody = document.getElementById("tabla-transacciones");
          document.getElementById("contador-trans").textContent =
            transaccionesCache.length;

          if (transaccionesCache.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">No tienes transacciones</td></tr>';
            return;
          }

          tbody.innerHTML = transaccionesCache
            .map(
              (t) => `
      <tr>
        <td><strong>#${t.id}</strong></td>
        <td><span class="badge bg-primary">${t.tipo}</span></td>
        <td>${t.detalle || "‚Äî"}</td>
        <td><strong>$${Number(t.monto).toFixed(2)}</strong></td>
        <td>${new Date(t.fecha).toLocaleString("es-EC")}</td>
      </tr>
    `,
            )
            .join("");
        } catch (error) {
          console.error("‚ùå Error:", error);
        }
      }

      async function buscarLineal() {
        const query = document.getElementById("input-lineal").value.trim();
        const resultDiv = document.getElementById("result-lineal");
        const tbody = document.getElementById("tabla-lineal");

        if (!query) {
          alert(" Ingresa una palabra clave");
          return;
        }

        try {
          resultDiv.style.display = "block";
          resultDiv.textContent = "üîç Buscando con algoritmo LINEAL...";

          const res = await fetch(
            `${API_URL}/estudiante/buscar-movimiento?query=${encodeURIComponent(query)}`,
            { headers: getHeaders() },
          );
          if (!res.ok) throw new Error("Error");
          const resultado = await res.json();

          if (resultado.message || resultado.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">No se encontraron resultados</td></tr>';
            resultDiv.textContent = "No se encontraron coincidencias";
            return;
          }

          tbody.innerHTML = resultado
            .map(
              (t) => `
      <tr>
        <td><strong>#${t.id}</strong></td>
        <td><span class="badge bg-primary">${t.tipo}</span></td>
        <td>${t.detalle || "‚Äî"}</td>
        <td><strong>$${Number(t.monto).toFixed(2)}</strong></td>
        <td>${new Date(t.fecha).toLocaleString("es-EC")}</td>
      </tr>
    `,
            )
            .join("");

          resultDiv.textContent = ` ${resultado.length} resultado(s) encontrado(s) con b√∫squeda LINEAL`;
        } catch (error) {
          console.error(" Error:", error);
          resultDiv.textContent = " Error en la b√∫squeda";
        }
      }

      async function buscarBinaria() {
        const monto = parseFloat(
          document.getElementById("input-binaria").value,
        );
        const resultDiv = document.getElementById("result-binaria");
        const tbody = document.getElementById("tabla-binaria");

        if (isNaN(monto) || monto <= 0) {
          alert(" Ingresa un monto v√°lido");
          return;
        }

        try {
          resultDiv.style.display = "block";
          resultDiv.textContent = " Buscando con algoritmo BINARIO...";

          const res = await fetch(
            `${API_URL}/estudiante/buscar-monto?monto=${monto}`,
            { headers: getHeaders() },
          );
          if (!res.ok) throw new Error("Error");
          const resultado = await res.json();

          if (resultado.message) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999;">No se encontr√≥ ninguna transacci√≥n con ese monto exacto</td></tr>';
            resultDiv.textContent =
              "No se encontr√≥ ninguna transacci√≥n con ese monto";
            return;
          }

          tbody.innerHTML = `
      <tr>
        <td><strong>#${resultado.id}</strong></td>
        <td><span class="badge bg-primary">${resultado.tipo}</span></td>
        <td>${resultado.detalle || "‚Äî"}</td>
        <td><strong>$${Number(resultado.monto).toFixed(2)}</strong></td>
        <td>${new Date(resultado.fecha).toLocaleString("es-EC")}</td>
      </tr>
    `;

          resultDiv.textContent = ` Transacci√≥n encontrada con b√∫squeda BINARIA`;
        } catch (error) {
          console.error(" Error:", error);
          resultDiv.textContent = " Error en la b√∫squeda";
        }
      }

      async function cargarPrestamos() {
        try {
          const res = await fetch(
            `${API_URL}/estudiante/mis-prestamos-pendientes`,
            { headers: getHeaders() },
          );
          if (!res.ok) throw new Error("Error");
          const prestamos = await res.json();

          const tbody = document.getElementById("tabla-prestamos");
          document.getElementById("contador-prestamos").textContent =
            prestamos.length;

          if (prestamos.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">No tienes pr√©stamos activos</td></tr>';
            return;
          }

          tbody.innerHTML = prestamos
            .map((p) => {
              const fechaEst = new Date(p.fechaDevolucionEstimada);
              const vencido = fechaEst < new Date();

              return `
        <tr>
          <td><strong>#${p.id}</strong></td>
          <td style="font-weight:600;">${p.libro.titulo}</td>
          <td>${p.libro.autor || "‚Äî"}</td>
          <td>${new Date(p.fechaPrestamo).toLocaleDateString("es-EC")}</td>
          <td>${fechaEst.toLocaleDateString("es-EC")}</td>
          <td><span class="badge ${vencido ? "bg-danger" : "bg-success"}">${vencido ? "VENCIDO" : "ACTIVO"}</span></td>
        </tr>
      `;
            })
            .join("");
        } catch (error) {
          console.error(" Error:", error);
        }
      }

      async function cargarPila() {
        try {
          if (!usuarioActual) await cargarUsuario();

          const res = await fetch(
            `${API_URL}/transacciones/usuario/${usuarioActual.id}/pila`,
            { headers: getHeaders() },
          );
          if (!res.ok) throw new Error("Error");
          const pila = await res.json();

          const tbody = document.getElementById("tabla-pila");
          if (pila.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">No hay datos en la PILA</td></tr>';
            return;
          }

          tbody.innerHTML = pila
            .map(
              (t, index) => `
      <tr>
        <td><span class="badge bg-primary">${index + 1}</span></td>
        <td><strong>#${t.id}</strong></td>
        <td>${t.tipo}</td>
        <td>${t.detalle || "‚Äî"}</td>
        <td><strong>$${Number(t.monto).toFixed(2)}</strong></td>
        <td>${new Date(t.fecha).toLocaleString("es-EC")}</td>
      </tr>
    `,
            )
            .join("");
        } catch (error) {
          console.error(" Error:", error);
        }
      }

      async function bloquearTarjeta() {
        if (
          !confirm(
            " ¬øEst√°s ABSOLUTAMENTE SEGURO?\n\nEsta acci√≥n bloquear√° tu tarjeta PERMANENTEMENTE.\n\n¬°NO podr√°s usar NING√öN servicio del campus!",
          )
        ) {
          return;
        }

        try {
          const msgDiv = document.getElementById("bloqueo-msg");
          msgDiv.style.display = "block";
          msgDiv.style.background = "#FFF3E0";
          msgDiv.style.color = "#E65100";
          msgDiv.textContent = " Bloqueando tarjeta...";

          const res = await fetch(`${API_URL}/tarjetas/bloquear-mi-tarjeta`, {
            method: "POST",
            headers: getHeaders(),
          });

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || "Error al bloquear tarjeta");
          }

          const resultado = await res.json();

          msgDiv.style.background = "#C8E6C9";
          msgDiv.style.color = "#2E7D32";
          msgDiv.textContent = ` ${resultado.message}`;

          setTimeout(() => {
            alert(
              "Tu tarjeta ha sido bloqueada exitosamente.\n\nCerrando sesi√≥n...",
            );
            localStorage.removeItem("jwt_token");
            window.location.href = "../index.html";
          }, 2000);
        } catch (error) {
          console.error(" Error:", error);
          const msgDiv = document.getElementById("bloqueo-msg");
          msgDiv.style.display = "block";
          msgDiv.style.background = "#FFCDD2";
          msgDiv.style.color = "#C62828";
          msgDiv.textContent = ` ${error.message}`;
        }
      }

      // ========== MODAL PERFIL ==========
      async function abrirModalPerfil() {
        console.log(" Abriendo modal de perfil...");

        if (!usuarioActual) {
          await cargarUsuario();
        }

        if (!usuarioActual) {
          alert(" Error: No se pudo cargar la informaci√≥n del usuario");
          return;
        }

        // Datos b√°sicos
        document.getElementById("perfil-nombre").textContent =
          usuarioActual.nombreCompleto || "Usuario";
        document.getElementById("perfil-email").textContent =
          usuarioActual.email || "‚Äî";
        document.getElementById("perfil-nombre-completo").textContent =
          usuarioActual.nombreCompleto || "‚Äî";
        document.getElementById("perfil-correo").textContent =
          usuarioActual.email || "‚Äî";
        document.getElementById("perfil-carrera").textContent =
          usuarioActual.carrera || "No especificada";
        document.getElementById("perfil-id").textContent =
          `#${usuarioActual.id}`;
        document.getElementById("perfil-saldo").textContent =
          `$${Number(usuarioActual.saldo || 0).toFixed(2)}`;

        // Cargar informaci√≥n de la tarjeta
        try {
          const res = await fetch(
            `${API_URL}/tarjetas/usuario/${usuarioActual.id}`,
            { headers: getHeaders() },
          );
          if (res.ok) {
            const tarjeta = await res.json();
            document.getElementById("perfil-rfid").textContent =
              tarjeta.codigoRfid || "‚Äî";

            const estadoBadge = tarjeta.bloqueada
              ? '<span style="color:#E53935;font-weight:700;"> BLOQUEADA</span>'
              : '<span style="color:#43A047;font-weight:700;"> ACTIVA</span>';
            document.getElementById("perfil-estado").innerHTML = estadoBadge;

            
          }
        } catch (error) {
          console.error(" Error al cargar tarjeta:", error);
          document.getElementById("perfil-rfid").textContent =
            "Error al cargar";
          document.getElementById("perfil-estado").textContent = "‚Äî";
          
        }

        // Estad√≠sticas
        try {
          const resTrans = await fetch(
            `${API_URL}/estudiante/mis-transacciones`,
            { headers: getHeaders() },
          );
          if (resTrans.ok) {
            const trans = await resTrans.json();
            document.getElementById("perfil-total-transacciones").textContent =
              trans.length;
          }
        } catch (error) {
          console.error(" Error al cargar transacciones:", error);
        }

        try {
          const resPrest = await fetch(
            `${API_URL}/estudiante/mis-prestamos-pendientes`,
            { headers: getHeaders() },
          );
          if (resPrest.ok) {
            const prest = await resPrest.json();
            document.getElementById("perfil-total-prestamos").textContent =
              prest.length;
          }
        } catch (error) {
          console.error(" Error al cargar pr√©stamos:", error);
        }

        // Mostrar modal
        document.getElementById("modal-perfil").classList.add("active");
        console.log(" Modal de perfil abierto");
      }

      function cerrarModalPerfil() {
        document.getElementById("modal-perfil").classList.remove("active");
        console.log(" Modal de perfil cerrado");
      }

      // Cerrar con ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          cerrarModalPerfil();
        }
      });

      window.addEventListener("DOMContentLoaded", async () => {
        console.log(" Sistema iniciado");
        await cargarDashboard();
      });
    </script>
  </body>
</html>
