<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RFID</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/global.css">
    <style>
        /* === ESTILOS GENERALES === */
        body { overflow: hidden; }
        .layout { display: flex; height: 100vh; width: 100vw; }
        
        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: rgba(33, 28, 41, 0.95);
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        .sidebar h3 { margin-bottom: 40px; text-align: center; color: #fff; font-size: 1.2rem; }
        
        .menu-item {
            padding: 16px; cursor: pointer; border-radius: 12px; margin-bottom: 8px;
            transition: all 0.3s ease; color: #b0a3c1; font-weight: 500; display: flex; gap: 12px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.08); color: #fff; transform: translateX(5px); }
        .menu-item.active { 
            background: linear-gradient(90deg, rgba(155, 126, 196, 0.2) 0%, transparent 100%);
            color: #fff; border-left: 4px solid #9b7ec4;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; padding: 40px; overflow-y: auto;
            background: linear-gradient(135deg, #2b2438 0%, #4a3b5e 100%);
        }

        /* VISTAS */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS REPORTES */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card h4 { color: #b0a3c1; font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card .number { color: #fff; font-size: 2rem; font-weight: bold; }
        .stat-card .icon { float: right; font-size: 2rem; opacity: 0.2; }

        /* TABLAS Y OTROS */
        .header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: white; font-size: 2rem; font-weight: 700; }
        
        .glass-table-container {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
            padding: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        thead th { color: #b0a3c1; padding: 0 15px 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;}
        tbody tr { background: rgba(255,255,255,0.03); transition: 0.2s; }
        tbody tr:hover { background: rgba(255,255,255,0.08); transform: scale(1.005); }
        td { padding: 15px; color: white; vertical-align: middle; }
        td:first-child { border-radius: 10px 0 0 10px; }
        td:last-child { border-radius: 0 10px 10px 0; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .bg-admin { background: rgba(161, 140, 209, 0.2); color: #d4c2fc; border: 1px solid rgba(161, 140, 209, 0.3); }
        .bg-student { background: rgba(100, 255, 218, 0.1); color: #64ffda; border: 1px solid rgba(100, 255, 218, 0.2); }
        .bg-bar { background: rgba(255, 159, 67, 0.1); color: #ff9f43; border: 1px solid rgba(255, 159, 67, 0.2); }
        
        .btn-action { background: rgba(255,255,255,0.1); color: white; border: none; width: 35px; height: 35px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: #9b7ec4; color: #fff; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: #2a2435; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 400px; border-radius: 16px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="layout">
        <div class="sidebar">
            <h3><i class="fas fa-shield-alt"></i> ADMIN</h3>
            
            <div class="menu-item active" onclick="cambiarVista('usuarios', this)">
                <i class="fas fa-users"></i> Gestión Usuarios
            </div>
            <div class="menu-item" onclick="cambiarVista('reportes', this)">
                <i class="fas fa-chart-pie"></i> Reportes
            </div>

            <div class="menu-item" style="margin-top: auto; color: #ff6b6b;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </div>
        </div>

        <div class="main-content">
            
            <div id="view-usuarios" class="view-section active">
                <div class="header-dash">
                    <h1>Gestión de Usuarios</h1>
                    <button class="btn-primary" onclick="cargarUsuarios()"><i class="fas fa-sync-alt"></i> Refrescar</button>
                </div>
                <div class="glass-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Rol Asignado</th>
                                <th>Tarjeta RFID</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaUsuarios">
                            <tr><td colspan="5" style="text-align:center">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-reportes" class="view-section">
                <div class="header-dash">
                    <h1>Métricas del Sistema</h1>
                    <span style="color: #b0a3c1;">Vista general de la universidad</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 4px solid #64ffda;">
                        <i class="fas fa-user-graduate icon"></i>
                        <h4>Estudiantes Activos</h4>
                        <div class="number" id="stat-estudiantes">--</div>
                    </div>
                    
                    <div class="stat-card" style="border-left: 4px solid #ff9f43;">
                        <i class="fas fa-wallet icon"></i>
                        <h4>Dinero en Sistema</h4>
                        <div class="number" id="stat-dinero">--</div>
                    </div>
                    
                    <div class="stat-card" style="border-left: 4px solid #9b7ec4;">
                        <i class="fas fa-users icon"></i>
                        <h4>Total Usuarios</h4>
                        <div class="number" id="stat-usuarios">--</div>
                    </div>
                    
                    <div class="stat-card" style="border-left: 4px solid #ff6b6b;">
                        <i class="fas fa-id-card icon"></i>
                        <h4>Cobertura Tarjetas</h4>
                        <div class="number" id="stat-tarjetas">--%</div>
                    </div>
                </div>

                <h3 style="color: white; margin-bottom: 20px;">Actividad Reciente (Simulada)</h3>
                <div class="glass-table-container">
                    <p style="color: #b0a3c1; font-style: italic; padding: 10px;">
                        * Nota: Esta tabla mostrará datos reales cuando se implementen los módulos de Bar y Biblioteca.
                    </p>
                    <table>
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Acción</th>
                                <th>Usuario</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Hace 5 min</td>
                                <td>Login Sistema</td>
                                <td>admin@ude.edu.ec</td>
                                <td><span class="badge bg-admin">Acceso</span></td>
                            </tr>
                            <tr>
                                <td>Hace 12 min</td>
                                <td>Actualización Perfil</td>
                                <td>erickGonzalez</td>
                                <td><span class="badge bg-student">Cambio Datos</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <h2 style="color:white; margin-bottom: 20px;">✏️ Editar Usuario</h2>
            <input type="hidden" id="editId">
            <label style="color:#b0a3c1; display:block; margin-bottom:5px">Rol de Usuario</label>
            <select id="editRol" style="background: rgba(0,0,0,0.3); border:1px solid #555; width:100%; padding:10px; color:white; border-radius:8px; margin-bottom:15px">
                <option value="ROLE_ESTUDIANTE">Estudiante</option>
                <option value="ROLE_ADMIN_BAR">Encargado del Bar</option>
                <option value="ROLE_ADMIN_BIBLIOTECA">Bibliotecario</option>
                <option value="ROLE_ADMIN">Administrador (Admin)</option>
            </select>
            <label style="color:#b0a3c1; display:block; margin-bottom:5px">Código Tarjeta RFID</label>
            <input type="text" id="editRfid" placeholder="Ej: 0506351513" style="background: rgba(0,0,0,0.3); border:1px solid #555; width:100%; padding:10px; color:white; border-radius:8px; margin-bottom:20px">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-primary" style="background: #ff6b6b;" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script src="js/utils/auth.js"></script>

    <script>
        protegerRuta();
        const token = obtenerToken();
        const rolUsuario = obtenerRolUsuario();

        if (rolUsuario !== 'ROLE_ADMIN') {
            alert("No tienes permisos de Administrador");
            redirigirSegunRol();
        }

        // --- NAVEGACIÓN ENTRE PESTAÑAS ---
        function cambiarVista(vistaNombre, elementoMenu) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + vistaNombre).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            elementoMenu.classList.add('active');

            // Si entra a reportes, cargamos los datos reales
            if(vistaNombre === 'reportes') {
                cargarReportesReales();
            }
        }

        // --- CARGAR REPORTES  ---
        async function cargarReportesReales() {
            try {
                const res = await fetch("http://localhost:8080/api/usuarios/dashboard/stats", {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(res.ok) {
                    const stats = await res.json();
                    
                    // Inyectamos los números reales
                    document.getElementById('stat-estudiantes').innerText = stats.totalEstudiantes;
                    document.getElementById('stat-usuarios').innerText = stats.totalUsuarios;
                    document.getElementById('stat-tarjetas').innerText = stats.tarjetasAsignadas + "%";
                    
                    // Formato de dinero bonito ($ 5.50)
                    const dineroFormateado = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(stats.dineroTotal);
                    document.getElementById('stat-dinero').innerText = dineroFormateado;
                }
            } catch (error) {
                console.error("Error cargando estadísticas", error);
            }
        }

        // --- FUNCIONES DE USUARIOS (IGUAL QUE ANTES) ---
        async function cargarUsuarios() {
            try {
                const res = await fetch("http://localhost:8080/api/usuarios", {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Error usuarios");
                const usuarios = await res.json();
                
                const tbody = document.getElementById('tablaUsuarios');
                tbody.innerHTML = '';

                usuarios.forEach(u => {
                    let rfidEncontrado = u.uidTarjeta || u.uid_tarjeta || (u.tarjeta ? u.tarjeta.uid || u.tarjeta.codigo : null);
                    let tarjetaDisplay = rfidEncontrado 
                        ? `<span style="color:#64ffda; font-family:monospace; font-weight:bold"><i class="fas fa-id-card"></i> ${rfidEncontrado}</span>`
                        : `<span style="color:#ff6b6b; font-size: 0.9em"><i class="fas fa-exclamation-triangle"></i> Sin Asignar</span>`;
                    
                    let rolNombre = u.rol ? u.rol.nombre : (u.rolNombre || "N/A");
                    let rolClass = "bg-student";
                    if (rolNombre === 'ROLE_ADMIN') rolClass = "bg-admin";
                    if (rolNombre.includes('BAR') || rolNombre.includes('BIBLIOTECA')) rolClass = "bg-bar";
                    let rolVisual = rolNombre.replace('ROLE_', '');

                    tbody.innerHTML += `
                        <tr>
                            <td>#${u.id}</td>
                            <td>
                                <div style="font-weight:bold">${u.email}</div>
                                <div style="font-size:0.8rem; opacity:0.6">${u.nombre || 'Usuario'}</div>
                            </td>
                            <td><span class="badge ${rolClass}">${rolVisual}</span></td>
                            <td>${tarjetaDisplay}</td>
                            <td>
                                <button class="btn-action" onclick="abrirModal(${u.id}, '${rolNombre}', '${rfidEncontrado || ''}')"><i class="fas fa-pen"></i></button>
                            </td>
                        </tr>`;
                });
            } catch (error) { console.error(error); }
        }

        function abrirModal(id, rolActual, rfidActual) {
            document.getElementById('editId').value = id;
            document.getElementById('editRfid').value = rfidActual;
            document.getElementById('editRol').value = rolActual; 
            document.getElementById('modalEditar').style.display = 'flex';
        }

        function cerrarModal() { document.getElementById('modalEditar').style.display = 'none'; }

        async function guardarCambios() {
            const id = document.getElementById('editId').value;
            const rol = document.getElementById('editRol').value;
            const tarjetaUid = document.getElementById('editRfid').value.trim();

            if (!rol) return alert("Selecciona un rol.");
            if (!tarjetaUid && !confirm("¿Estás seguro de dejar a este usuario SIN tarjeta?")) return;

            try {
                const res = await fetch(`http://localhost:8080/api/usuarios/${id}/asignar-datos`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ "rol": rol, "tarjetaUid": tarjetaUid })
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok) { alert('✅ Actualizado'); cerrarModal(); cargarUsuarios(); } 
                else { alert(`❌ Error: ${data.message || "Revisa consola"}`); }
            } catch (e) { alert('❌ Error de conexión'); }
        }

        function logout() { if(confirm("¿Cerrar sesión?")) cerrarSesion(); }

        cargarUsuarios();
    </script>
</body>
</html>