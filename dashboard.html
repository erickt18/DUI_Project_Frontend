<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RFID</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/global.css">
    <style>
        /* === ESTILOS DEL DASHBOARD === */
        body { overflow: hidden; }
        .layout { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar {
            width: 260px;
            background: rgba(33, 28, 41, 0.95);
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        .sidebar h3 { margin-bottom: 40px; text-align: center; color: #fff; font-size: 1.2rem; }
        
        .menu-item {
            padding: 16px; cursor: pointer; border-radius: 12px; margin-bottom: 8px;
            transition: all 0.3s ease; color: #b0a3c1; font-weight: 500; display: flex; gap: 12px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.08); color: #fff; transform: translateX(5px); }
        .menu-item.active { 
            background: linear-gradient(90deg, rgba(155, 126, 196, 0.2) 0%, transparent 100%);
            color: #fff; border-left: 4px solid #9b7ec4;
        }

        .main-content {
            flex: 1; padding: 40px; overflow-y: auto;
            background: linear-gradient(135deg, #2b2438 0%, #4a3b5e 100%);
        }

        .header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: white; font-size: 2rem; font-weight: 700; }

        .glass-table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        thead th { color: #b0a3c1; padding: 0 15px 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left;}
        tbody tr { background: rgba(255,255,255,0.03); transition: 0.2s; }
        tbody tr:hover { background: rgba(255,255,255,0.08); transform: scale(1.005); }
        td { padding: 15px; color: white; vertical-align: middle; }
        td:first-child { border-radius: 10px 0 0 10px; }
        td:last-child { border-radius: 0 10px 10px 0; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .bg-admin { background: rgba(161, 140, 209, 0.2); color: #d4c2fc; border: 1px solid rgba(161, 140, 209, 0.3); }
        .bg-student { background: rgba(100, 255, 218, 0.1); color: #64ffda; border: 1px solid rgba(100, 255, 218, 0.2); }
        .bg-bar { background: rgba(255, 159, 67, 0.1); color: #ff9f43; border: 1px solid rgba(255, 159, 67, 0.2); }
        
        .btn-action {
            background: rgba(255,255,255,0.1); color: white; border: none; width: 35px; height: 35px;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .btn-action:hover { background: #9b7ec4; color: #fff; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #2a2435; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 400px;
            border-radius: 16px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="layout">
        <div class="sidebar">
            <h3><i class="fas fa-shield-alt"></i> SUPER ADMIN</h3>
            <div class="menu-item active"><i class="fas fa-users"></i> Gesti√≥n Usuarios</div>
            <div class="menu-item" onclick="alert('Pr√≥ximamente')"><i class="fas fa-chart-pie"></i> Reportes</div>
            <div class="menu-item" onclick="alert('Pr√≥ximamente')"><i class="fas fa-cog"></i> Configuraci√≥n</div>
            <div class="menu-item" style="margin-top: auto; color: #ff6b6b;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </div>
        </div>

        <div class="main-content">
            <div class="header-dash">
                <h1>Gesti√≥n de Usuarios</h1>
                <button class="btn-primary" onclick="cargarUsuarios()"><i class="fas fa-sync-alt"></i> Refrescar</button>
            </div>

            <div class="glass-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Rol Asignado</th>
                            <th>Tarjeta RFID</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaUsuarios">
                        <tr><td colspan="5" style="text-align:center">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <h2 style="color:white; margin-bottom: 20px;">‚úèÔ∏è Editar Usuario</h2>
            <input type="hidden" id="editId">
            
            <label style="color:#b0a3c1; display:block; margin-bottom:5px">Rol de Usuario</label>
            <select id="editRol" style="background: rgba(0,0,0,0.3); border:1px solid #555; width:100%; padding:10px; color:white; border-radius:8px; margin-bottom:15px">
                <option value="ROLE_ESTUDIANTE">Estudiante</option>
                <option value="ROLE_ADMIN_BAR">Encargado del Bar</option>
                <option value="ROLE_ADMIN_BIBLIOTECA">Bibliotecario</option>
                <option value="ROLE_ADMIN">Administrador (Admin)</option>
            </select>

            <label style="color:#b0a3c1; display:block; margin-bottom:5px">C√≥digo Tarjeta RFID</label>
            <input type="text" id="editRfid" placeholder="Ej: 0506351513" style="background: rgba(0,0,0,0.3); border:1px solid #555; width:100%; padding:10px; color:white; border-radius:8px; margin-bottom:20px">

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-primary" style="background: #ff6b6b;" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-primary" onclick="guardarCambios()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script src="js/utils/auth.js"></script>

    <script>
        // 1. SEGURIDAD
        protegerRuta();
        const token = obtenerToken();
        const rolUsuario = obtenerRolUsuario();

        if (rolUsuario !== 'ROLE_ADMIN') {
            alert("No tienes permisos de Administrador");
            redirigirSegunRol();
        }

        // 2. CARGAR USUARIOS
        async function cargarUsuarios() {
            try {
                const res = await fetch("http://localhost:8080/api/usuarios", {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("Error al obtener usuarios");

                const usuarios = await res.json();
                console.log("Usuarios recibidos:", usuarios);

                const tbody = document.getElementById('tablaUsuarios');
                tbody.innerHTML = '';

                usuarios.forEach(u => {
                    // DETECCI√ìN DE TARJETA
                    let rfidEncontrado = null;
                    if (u.uidTarjeta) rfidEncontrado = u.uidTarjeta;           
                    else if (u.uid_tarjeta) rfidEncontrado = u.uid_tarjeta;    
                    else if (u.tarjeta && u.tarjeta.uid) rfidEncontrado = u.tarjeta.uid; 
                    else if (u.tarjeta && u.tarjeta.codigo) rfidEncontrado = u.tarjeta.codigo;

                    let tarjetaDisplay = rfidEncontrado 
                        ? `<span style="color:#64ffda; font-family:monospace; font-weight:bold"><i class="fas fa-id-card"></i> ${rfidEncontrado}</span>`
                        : `<span style="color:#ff6b6b; font-size: 0.9em"><i class="fas fa-exclamation-triangle"></i> Sin Asignar</span>`;
                    
                    let tarjetaValorModal = rfidEncontrado || "";

                    // ROLES
                    let rolNombre = "N/A";
                    if (u.rol && u.rol.nombre) rolNombre = u.rol.nombre;
                    else if (u.rolNombre) rolNombre = u.rolNombre;
                    
                    let rolClass = "bg-student";
                    if (rolNombre === 'ROLE_ADMIN') rolClass = "bg-admin";
                    if (rolNombre.includes('BAR') || rolNombre.includes('BIBLIOTECA')) rolClass = "bg-bar";

                    let rolVisual = rolNombre.replace('ROLE_', '');

                    tbody.innerHTML += `
                        <tr>
                            <td>#${u.id}</td>
                            <td>
                                <div style="font-weight:bold">${u.email}</div>
                                <div style="font-size:0.8rem; opacity:0.6">${u.nombre || 'Usuario'}</div>
                            </td>
                            <td><span class="badge ${rolClass}">${rolVisual}</span></td>
                            <td>${tarjetaDisplay}</td>
                            <td>
                                <button class="btn-action" onclick="abrirModal(${u.id}, '${rolNombre}', '${tarjetaValorModal}')" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error(error);
                document.getElementById('tablaUsuarios').innerHTML = `<tr><td colspan="5" style="color:red; text-align:center">Error: ${error.message}</td></tr>`;
            }
        }

        // 3. ABRIR MODAL
        function abrirModal(id, rolActual, rfidActual) {
            document.getElementById('editId').value = id;
            document.getElementById('editRfid').value = rfidActual;
            
            const selectRol = document.getElementById('editRol');
            selectRol.value = rolActual; 

            document.getElementById('modalEditar').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalEditar').style.display = 'none';
        }

        // 4. GUARDAR CAMBIOS (CON PROTECCI√ìN DE BORRADO) üõ°Ô∏è
        async function guardarCambios() {
            const id = document.getElementById('editId').value;
            const rol = document.getElementById('editRol').value;
            const tarjetaUid = document.getElementById('editRfid').value.trim(); // Limpia espacios

            // Validaci√≥n visual
            if (!rol) {
                alert("‚ö†Ô∏è Error: Debes seleccionar un rol.");
                return;
            }

            // üëá AQU√ç EST√Å LA MAGIA DE LA CONFIRMACI√ìN üëá
            if (!tarjetaUid) {
                const seguro = confirm("‚ö†Ô∏è ¬øEst√°s seguro de dejar a este usuario SIN tarjeta?\nEsto borrar√° la vinculaci√≥n actual.");
                if (!seguro) return; // Si dice 'Cancelar', no hacemos nada
            }

            console.log("Enviando al backend:", { rol: rol, tarjetaUid: tarjetaUid });

            try {
                const url = `http://localhost:8080/api/usuarios/${id}/asignar-datos`;
                
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        "rol": rol, 
                        "tarjetaUid": tarjetaUid 
                    })
                });

                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    alert('‚úÖ ¬°√âxito! Usuario actualizado correctamente.');
                    cerrarModal();
                    cargarUsuarios(); 
                } else {
                    console.error("Error backend:", data);
                    alert(`‚ùå Error: ${data.error || data.message || "Revisa la consola."}`);
                }

            } catch (e) {
                console.error(e);
                alert('‚ùå Error de conexi√≥n. Revisa que Java est√© corriendo.');
            }
        }

        function logout() {
            if(confirm("¬øEst√°s seguro de que deseas cerrar sesi√≥n?")) {
                cerrarSesion();
            }
        }

        cargarUsuarios();
    </script>
</body>
</html>